<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/LabelSync.js | GitHub Issues Label Sync Module API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/superleap/github-issues-label-sync.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/LabelSync.js~GithubIssuesLabelSync.html">GithubIssuesLabelSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Label">Label</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/LabelSync.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">let GitHubApi = require(&quot;github&quot;);
let Promise = require(&apos;bluebird&apos;);

/**
 * Simple wrapper around the github module issues function
 * @access public
 */
export default class GithubIssuesLabelSync {
    /**
     * The GitHub issue label model
     * @typedef {Object} Label
     * @property {String} Label.name - The name of the label
     * @property {String} [Label.color] - The colour of the label
     * @property {String} [Label.status] - Once a label operation is complete this field gets updated
     */

    /**
     * In order to work as an NPM module this class has to be called with specific parameters
     * @example
     * let fs = require(&apos;fs&apos;);
     * let Promise = require(&apos;bluebird&apos;);
     * let config = {
     *   &quot;github&quot;: {
     *     &quot;user&quot;: &quot;superleap&quot;,
     *     &quot;repo&quot;: &quot;github-issues-label-sync&quot;,
     *     &quot;token&quot;: &quot;dab5ae868be49ec9179b34d2532d699a603f8be0&quot;,
     *     &quot;options&quot;: {
     *       // all other values in this array are defaults
     *       &quot;debug&quot;: true,
     *       &quot;followRedirects&quot;: false,
     *       &quot;Promise&quot;: Promise
     *     }
     *   }
     * };
     * let {user, repo, token, options} = config.github;
     * let labels = [];
     * array.from(JSON.parse(fs.readFileSync(&apos;./.issuesrc&apos;, &apos;utf8&apos;)).categories).forEach((category) =&gt; {
     *   category.labels.forEach((label) =&gt; {
     *     label.name = `${category.name}: ${label.name}`;
     *     labels.push(label);
     *   });
     * });
     * let githubSync = new (require(&apos;./lib/LabelSync&apos;))(options, user, repo, token);
     * @param {Object} [options={}] - GitHubApi connect options
     * @param {String} user - GitHub repository user
     * @param {String} repo - GitHub repository name
     * @param {String} token - GitHub personal access token
     */
    constructor(options = {}, user, repo, token) {
        this.options = options;
        this.user = user;
        this.repo = repo;
        this.token = token;
        this.github = new GitHubApi(this.options);
        this._labels = [];
        this._deletedLabels = [];
        this._createdLabels = [];

        this.authenticate();
    }

    /**
     * Get GitHubApi module connect options
     * @type {Object}
     */
    get options() {
        return this._options;
    }

    /**
     * Get GitHub repository username
     * @type {String}
     */
    get user() {
        return this._user;
    }

    /**
     * Get GitHub repository name
     * @type {String}
     */
    get repo() {
        return this._repo;
    }

    /**
     * Get GitHub repository token
     * @type {String}
     */
    get token() {
        return this._token;
    }

    /**
     * Get GitHubApi module
     * @link github/Client
     * @type {github/Client|module.exports}
     */
    get github() {
        return this._github;
    }

    /**
     * Get GitHub repository labels
     * @type {Array&lt;GithubIssuesLabelSync.Label&gt;}
     */
    get labels() {
        return this._labels;
    }

    /**
     * Get GitHubApi repository deleted labels
     * @type {Array&lt;GithubIssuesLabelSync.Label&gt;}
     */
    get deletedLabels() {
        return this._deletedLabels;
    }

    /**
     * Get GitHubApi repository created labels
     * @type {Array&lt;GithubIssuesLabelSync.Label&gt;}
     */
    get createdLabels() {
        return this._createdLabels;
    }

    /**
     * Set GitHubApi module connect options
     * @type {Object}
     * @property {Boolean} [options.debug=false] - Get request information with each call
     * @property {Boolean} [options.followRedirects=false] - We don&apos;t need this for issues
     * @property {Promise} Promise - We are using bluebird promises peering with github api package
     */
    set options(object) {
        this._options = object;
    }

    /**
     * Set GitHubApi repository username
     * @type {String}
     */
    set user(repoUrlUser) {
        this._user = repoUrlUser;
    }

    /**
     * Set GitHubApi repository name
     * @type {String}
     */
    set repo(repoUrlName) {
        this._repo = repoUrlName;
    }

    /**
     * Set GitHubApi OAuth2 personal access token
     * @type {String}
     */
    set token(personalAccessToken) {
        this._token = personalAccessToken;
    }

    /**
     * Set GitHubApi Client
     * @type {github/Client|module.exports}
     */
    set github(Client) {
        this._github = Client;
    }

    /**
     * Set GitHubApi repository labels
     * @type {Array&lt;GithubIssuesLabelSync.Label&gt;}
     */
    set labels(labels) {
        this._labels = labels;
    }

    /**
     * Push GitHubApi repository deleted label
     * @type {GithubIssuesLabelSync.Label}
     */
    set deletedLabel(label) {
        this._deletedLabels.push(label);
    }

    /**
     * Push GitHubApi repository created label
     * @type {GithubIssuesLabelSync.Label}
     */
    set createdLabel(label) {
        this._createdLabels.push(label);
    }

    /**
     * We only do this once
     * @access private
     */
    authenticate() {
        this.github.authenticate({
            type: &quot;oauth&quot;,
            token: this.token
        });
    }

    /**
     * Get GitHubApi repository labels from remote
     * @example
     * githubSync.getLabels().then((response) =&gt; {
     *   // log labels
     *   console.log(response);
     * });
     * @async
     * @param {Boolean} [meta=false] - Get extended response information
     * @returns {Promise}
     */
    getLabels(meta = false) {
        return this.github.issues.getLabels({
            user: this.user,
            repo: this.repo
        }).then((response) =&gt; {
            if (true !== meta) {
                delete response[&quot;meta&quot;];
            }

            this.labels = response;

            return this.labels;
        });
    }

    /**
     * Delete GitHubApi repository label from remote
     * @example
     * githubSync.deleteLabel(labels).then((response) =&gt; {
     *   // log raw response bodies
     *   console.log(response);
     *   // log deleted label
     *   console.log(githubSync.createdLabels);
     * });
     * @async
     * @param {GithubIssuesLabelSync.Label} label - The label we want to delete
     * @param {String} label.name - The label&apos;s name
     * @returns {Promise}
     */
    deleteLabel(label) {
        return this.github.issues.deleteLabel({
            user: this.user,
            repo: this.repo,
            name: label.name
        }).then((response) =&gt; {
            label.status = &apos;success&apos;;

            return response;
        }).catch((error) =&gt; {
            label.status = &apos;error&apos;;

            return error.message;
        }).lastly(() =&gt; {
            this.deletedLabel = label;

            return label;
        });
    }

    /**
     * Delete GitHubApi repository labels from remote
     * @example
     * githubSync.deleteLabels(labels).then((response) =&gt; {
     *   // log raw response bodies
     *   console.log(response);
     *   // log delete labels
     *   console.log(githubSync.deletedLabels);
     * });
     * @async
     * @param {Array&lt;GithubIssuesLabelSync.Label&gt;} labels - The labels we want to delete
     * @returns {Promise}
     */
    deleteLabels(labels) {
        return Promise.all(labels).map((label) =&gt; {
            return this.deleteLabel(label);
        });
    }

    /**
     * Create GitHubApi repository label on remote
     * @example
     * githubSync.createLabel(label).then((response) =&gt; {
     *   // log raw response bodies
     *   console.log(response);
     *   // log created label
     *   console.log(githubSync.createdLabels);
     * });
     * @async
     * @param {GithubIssuesLabelSync.Label} label - The label we want to create
     * @param {String} label.name - The label&apos;s name
     * @param {String} label.color - The label&apos;s colour
     * @param {String} label.status - Promise status of operation
     * @returns {Promise}
     */
    createLabel(label) {
        return this.github.issues.createLabel({
            user: this.user,
            repo: this.repo,
            name: label.name,
            color: label.color
        }).then((response) =&gt; {
            label.status = &apos;success&apos;;

            return response;
        }).catch((response) =&gt; {
            let error = JSON.parse(response);
            let code = error[&quot;errors&quot;][0].code;

            if (code === &quot;already_exists&quot;) {
                label.status = &apos;duplicate&apos;;
            } else {
                label.status = &apos;error&apos;;
            }

            return error;
        }).lastly(() =&gt; {
            this.createdLabel = label;
        });
    }

    /**
     * Create GitHubApi repository labels on remote
     * @example
     * githubSync.createLabels(labels).then((response) =&gt; {
     *   // log raw response bodies
     *   console.log(response);
     *   // log created/updated labels
     *   console.log(githubSync.createdLabels);
     * });
     * @async
     * @param {Array&lt;GithubIssuesLabelSync.Label&gt;} labels - The labels we want to create
     * @returns {Promise}
     */
    createLabels(labels) {
        return Promise.all(labels).map((label) =&gt; {
            return this.createLabel(label);
        });
    }

    /**
     * Delete all GitHubApi repository labels on remote
     * @example
     * githubSync.purgeLabels().then((response) =&gt; {
     *   // log raw response bodies
     *   console.log(response);
     *   // log deleted labels
     *   console.log(githubSync.deletedLabels);
     * });
     * @async
     * @returns {Promise}
     */
    purgeLabels() {
        return this.getLabels().then((labels) =&gt; {
            return Promise.all(labels).map((label) =&gt; {
                return this.deleteLabel(label);
            });
        });
    }

    /**
     * Import all GitHubApi repository labels on remote while optionally removing all the others
     * @example
     * githubSync.importLabels(labels).then((response) =&gt; {
     *   // log raw response bodies
     *   console.log(response);
     *   // log created/updated labels
     *   console.log(githubSync.createdLabels);
     * });
     * @async
     * @param {Array&lt;GithubIssuesLabelSync.Label&gt;} labels - The labels we want to import
     * @param {Boolean} [purge=false] - Wether to delete all existing tags on remote or not
     * @returns {Promise}
     */
    importLabels(labels, purge = true) {
        return Promise.resolve(true === purge ? this.purgeLabels() : true).then(() =&gt; {
            return this.createLabels(labels);
        });
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
