<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/LabelSync.js | GitHub Issues Label Sync Module API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-hacker-vision.css">
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/superleap/github-issues-label-sync.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/LabelSync.js~GithubIssuesLabelSync.html">GithubIssuesLabelSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-GithubApiClient">GithubApiClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Label">Label</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Promise">Promise</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/LabelSync.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import GithubApiClient from &apos;github&apos;;
import Promise from &apos;bluebird&apos;;

/**
 * Simple wrapper around the github module issues function
 * @access public
 */
export default class GithubIssuesLabelSync {

    /**
     * The node-github npmjs.com package
     * @typedef {Object} GithubApiClient
     * @see https://github.com/mikedeboer/node-github
     */

    /**
     * The bluebird npmjs.com package
     * @typedef {Object} Promise
     * @see https://github.com/petkaantonov/bluebird
     */

    /**
     * The github issue label model
     * @typedef {Object} Label
     * @property {String} Label.name The name of the label
     * @property {String} [Label.color] The colour of the label
     * @property {String} [Label.status] Once a label operation is complete this field gets updated
     */

    /**
     * In order to work as an NPM module this class has to be called with specific parameters
     * @example
     * let config = {
     *   &quot;github&quot;: {
     *     &quot;user&quot;: &quot;superleap&quot;,
     *     &quot;repo&quot;: &quot;github-issues-label-sync&quot;,
     *     &quot;token&quot;: process.env.GH_TOKEN,
     *     &quot;options&quot;: {
     *       &quot;debug&quot;: true
     *     }
     *   },
     *   &quot;categories&quot;: [
     *     {
     *       &quot;name&quot;: &quot;GH Review&quot;,
     *       &quot;labels&quot;: [
     *         {
     *           &quot;name&quot;: &quot;accepted&quot;,
     *           &quot;color&quot;: &quot;009800&quot;
     *         },
     *         {
     *           &quot;name&quot;: &quot;on hold&quot;,
     *           &quot;color&quot;: &quot;bfdadc&quot;
     *         },
     *         {
     *           &quot;name&quot;: &quot;review-needed&quot;,
     *           &quot;color&quot;: &quot;fbca04&quot;
     *         }
     *       ]
     *     },
     *     {
     *       &quot;name&quot;: &quot;Status&quot;,
     *       &quot;labels&quot;: [
     *         {
     *           &quot;name&quot;: &quot;new&quot;,
     *           &quot;color&quot;: &quot;006b75&quot;
     *         },
     *         {
     *           &quot;name&quot;: &quot;reverted&quot;,
     *           &quot;color&quot;: &quot;d93f0b&quot;
     *         }
     *       ]
     *     }
     *   ];
     * }
     * let labels = [];
     * let {user, repo, token, options} = config.github;
     * let githubIssuesLabelSync = new (require(&apos;./lib/LabelSync&apos;))(options, user, repo, token);
     * Array.from(config.categories).forEach((category) =&gt; {
     *   category.labels.forEach((label) =&gt; {
     *     label.name = `${category.name}: ${label.name}`;
     *     labels.push(label);
     *   });
     * });
     * @param {Object} [options={}] - github API Client options
     * @param {String} user - github repository user
     * @param {String} repo - github repository name
     * @param {String} token - github personal access token
     */
    constructor(options = {}, user, repo, token) {
        this.options = options;
        this.user = user;
        this.repo = repo;
        this.token = token;
        this.github = new GithubApiClient(this.options);
        this._labels = [];
        this._deletedLabels = [];
        this._createdLabels = [];

        this.authenticate();
    }

    /**
     * Get github API Client options
     * @type {Object}
     */
    get options() {
        return this._options;
    }

    /**
     * Get github repository username
     * @type {String}
     */
    get user() {
        return this._user;
    }

    /**
     * Get github repository name
     * @type {String}
     */
    get repo() {
        return this._repo;
    }

    /**
     * Get github repository token
     * @type {String}
     */
    get token() {
        return this._token;
    }

    /**
     * Get github API Client
     * @type {GithubApiClient}
     */
    get github() {
        return this._github;
    }

    /**
     * Get github repository labels
     * @type {Array&lt;GithubIssuesLabelSync.Label&gt;}
     */
    get labels() {
        return this._labels;
    }

    /**
     * Get github API repository deleted labels
     * @type {Array&lt;GithubIssuesLabelSync.Label&gt;}
     */
    get deletedLabels() {
        return this._deletedLabels;
    }

    /**
     * Get github API repository created labels
     * @type {Array&lt;GithubIssuesLabelSync.Label&gt;}
     */
    get createdLabels() {
        return this._createdLabels;
    }

    /**
     * Set github API Client options
     * @type {Object} Options we instantiate the github api package with
     * @property {Boolean} [options.debug=false] Get request information with each call
     * @property {Boolean} [options.followRedirects=false] We don&apos;t need this for issues
     * @property {Promise} Promise We are using bluebird promises peering with github api package
     */
    set options(object) {
        this._options = object;
        this._options.followRedirects = false;
        this._options.Promise = Promise;
    }

    /**
     * Set github API repository username
     * @type {String}
     */
    set user(repoUrlUser) {
        this._user = repoUrlUser;
    }

    /**
     * Set github API repository name
     * @type {String}
     */
    set repo(repoUrlName) {
        this._repo = repoUrlName;
    }

    /**
     * Set github API OAuth2 personal access token
     * @type {String}
     */
    set token(personalAccessToken) {
        this._token = personalAccessToken;
    }

    /**
     * Set github API Client
     * @type {GithubApiClient}
     */
    set github(GithubApiClient) {
        this._github = GithubApiClient;
    }

    /**
     * Set github API repository labels
     * @type {Array&lt;GithubIssuesLabelSync.Label&gt;}
     */
    set labels(labels) {
        this._labels = labels;
    }

    /**
     * Push github API repository deleted label
     * @type {GithubIssuesLabelSync.Label}
     */
    set deletedLabel(label) {
        this._deletedLabels.push(label);
    }

    /**
     * Push github API repository created label
     * @type {GithubIssuesLabelSync.Label}
     */
    set createdLabel(label) {
        this._createdLabels.push(label);
    }

    /**
     * We only do this once
     * @access private
     */
    authenticate() {
        this.github.authenticate({
            &quot;type&quot;: &quot;oauth&quot;,
            &quot;token&quot;: this.token
        });
    }

    /**
     * Get github API repository labels from remote
     * @example
     * githubIssuesLabelSync.getLabels().then((response) =&gt; {
     *   console.log(response);
     * }).catch((error) =&gt; {
     *   console.log(error.toJSON());
     * });
     * @async
     * @param {Boolean} [meta=false] - Get extended response information
     * @return {Promise&lt;GithubIssuesLabelSync.labels, Error&gt;} Array of existing labels
     */
    getLabels(meta = false) {
        return new Promise((resolve, reject) =&gt; {
            return this.github.issues.getLabels({
                &quot;user&quot;: this.user,
                &quot;repo&quot;: this.repo
            }, (error, response) =&gt; {
                if (error) {
                    reject(error);
                } else {
                    if (true !== meta) {
                        Reflect.deleteProperty(response, &apos;meta&apos;);
                    }

                    this.labels = response;

                    resolve(this.labels);
                }
            });
        });
    }

    /**
     * Delete github API repository label from remote
     * @example
     * githubIssuesLabelSync.deleteLabel(label).then((response) =&gt; {
     *   console.log(response);
     * }).catch((error) =&gt; {
     *   console.log(error.toJSON());
     * });
     * @async
     * @param {GithubIssuesLabelSync.Label} label - The label we want to delete
     * @param {String} label.name - The label&apos;s name
     * @return {Promise&lt;GithubIssuesLabelSync.deletedLabels, Error&gt;} Deleted label
     */
    deleteLabel(label) {
        return new Promise((resolve, reject) =&gt; {
            return this.github.issues.deleteLabel({
                &quot;user&quot;: this.user,
                &quot;repo&quot;: this.repo,
                &quot;name&quot;: label.name
            }, (error) =&gt; {
                let success = true;

                if (error) {
                    if (error.toJSON().code === 404) {
                        label.status = &apos;not found&apos;;
                    } else {
                        success = false;
                        reject(error);
                    }
                } else {
                    label.status = &apos;success&apos;;
                }

                if (success) {
                    this.deletedLabel = label;

                    resolve(this.deletedLabels);
                }
            });
        });
    }

    /**
     * Delete github API repository labels from remote
     * @example
     * githubIssuesLabelSync.deleteLabels(labels).then((response) =&gt; {
     *   console.log(response);
     * }).catch((error) =&gt; {
     *   console.log(error.toJSON());
     * });
     * @async
     * @param {Array&lt;GithubIssuesLabelSync.Label&gt;} labels - The labels we want to delete
     * @return {Promise&lt;GithubIssuesLabelSync.deletedLabels, Error&gt;} Array of deleted labels
     */
    deleteLabels(labels) {
        return Promise.all(labels).map((label) =&gt; {
            return this.deleteLabel(label);
        });
    }

    /**
     * Create github API repository label on remote
     * @example
     * githubIssuesLabelSync.createLabel(label).then((response) =&gt; {
     *   console.log(response);
     * }).catch((error) =&gt; {
     *   console.log(error.toJSON());
     * });
     * @async
     * @param {GithubIssuesLabelSync.Label} label - The label we want to create
     * @param {String} label.name - The label&apos;s name
     * @param {String} label.color - The label&apos;s colour
     * @param {String} label.status - Promise status of operation
     * @return {Promise&lt;GithubIssuesLabelSync.createdLabels, Error&gt;} Created label
     */
    createLabel(label) {
        return new Promise((resolve, reject) =&gt; {
            return this.github.issues.createLabel({
                &quot;user&quot;: this.user,
                &quot;repo&quot;: this.repo,
                &quot;name&quot;: label.name,
                &quot;color&quot;: label.color
            }, (error) =&gt; {
                let success = true;

                if (error) {
                    if (JSON.parse(error.toJSON().message).errors[0].code === &apos;already_exists&apos;) {
                        label.status = &apos;duplicate&apos;;
                    } else {
                        success = false;
                        reject(error);
                    }
                } else {
                    success = true;
                    label.status = &apos;success&apos;;
                }

                if (success) {
                    this.createdLabel = label;

                    resolve(this.createdLabels);
                }
            });
        });
    }

    /**
     * Create github API repository labels on remote
     * @example
     * githubIssuesLabelSync.importLabels(labels).then((response) =&gt; {
     *   console.log(response);
     * }).catch((error) =&gt; {
     *   console.log(error.toJSON());
     * });
     * @async
     * @param {Array&lt;GithubIssuesLabelSync.Label&gt;} labels - The labels we want to create
     * @return {Promise&lt;GithubIssuesLabelSync.createdLabels, Error&gt;} Array of created labels
     */
    createLabels(labels) {
        return Promise.all(labels).map((label) =&gt; {
            return this.createLabel(label);
        });
    }

    /**
     * Delete all github API repository labels on remote
     * @example
     * githubIssuesLabelSync.purgeLabels().then((response) =&gt; {
     *   console.log(response);
     * }).catch((error) =&gt; {
     *   console.log(error.toJSON());
     * });
     * @async
     * @return {Promise&lt;GithubIssuesLabelSync.deletedLabels, Error&gt;} Array of deleted labels
     */
    purgeLabels() {
        return this.getLabels().then((labels) =&gt; {
            return Promise.all(labels).map((label) =&gt; {
                return this.deleteLabel(label);
            });
        });
    }

    /**
     * Import all github API repository labels on remote while optionally removing all the others
     * @example
     * githubIssuesLabelSync.importLabels(labels, false).then((response) =&gt; {
     *   console.log(response);
     * }).catch((error) =&gt; {
     *   console.log(error.toJSON());
     * });
     * @async
     * @param {Array&lt;GithubIssuesLabelSync.Label&gt;} labels - The labels we want to import
     * @param {Boolean} [purge=false] - Wether to delete all existing tags on remote or not
     * @return {Promise&lt;GithubIssuesLabelSync.createdLabels, Error&gt;} Array of created labels
     */
    importLabels(labels, purge = true) {
        return Promise.resolve(true === purge ? this.purgeLabels() : true).then(() =&gt; {
            return this.createLabels(labels);
        });
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
